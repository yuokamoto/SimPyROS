#!/usr/bin/env python3
"""
Visual Backend Comparison Demo - UI„ÅßË¶ñË¶öÁöÑ„Å´„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÇíÊØîËºÉ
PyVista„Çí‰Ωø„Å£„Åü„É™„Ç¢„É´„Çø„Ç§„É†ÊÄßËÉΩÊØîËºÉ„Å®„É≠„Éú„ÉÉ„ÉàÂèØË¶ñÂåñ
"""

import sys
import os
import time
import math
import threading
from typing import Dict, List, Optional

sys.path.insert(0, os.path.join(os.path.dirname(__file__), "..", ".."))

import simpyros

try:
    import pyvista as pv
    import numpy as np
    PYVISTA_AVAILABLE = True
except ImportError:
    print("‚ö†Ô∏è PyVista not available. Install with: pip install pyvista")
    PYVISTA_AVAILABLE = False


class VisualComparisonDemo:
    """Ë¶ñË¶öÁöÑ„Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÊØîËºÉ„Éá„É¢"""
    
    def __init__(self):
        self.plotter = None
        self.running = False
        self.backends_data = {}
        self.update_thread = None
        
        # ÊØîËºÉÂØæË±°„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ
        self.backends = [
            (simpyros.SimulationBackend.SIMPLE_WHILE_LOOP, "Simple While Loop", "red"),
            (simpyros.SimulationBackend.SIMPY_FREQUENCY_GROUP, "SimPy FrequencyGroup", "blue")
        ]
        
        # „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
        self.num_robots_per_backend = 15
        self.robot_spacing = 8.0
        
    def setup_visualization(self):
        """ÂèØË¶ñÂåñ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó"""
        if not PYVISTA_AVAILABLE:
            raise ImportError("PyVista required for visual demo")
        
        self.plotter = pv.Plotter(window_size=[1400, 900])
        self.plotter.set_background('black')
        
        # „Ç´„É°„É©Ë®≠ÂÆö
        self.plotter.camera_position = [(0, -50, 30), (0, 0, 0), (0, 0, 1)]
        
        # „Çø„Ç§„Éà„É´ËøΩÂä†
        self.plotter.add_text(
            "SimPyROS Backend Performance Comparison", 
            position='upper_edge',
            font_size=16,
            color='white'
        )
        
        # Âá°‰æã„Ç®„É™„Ç¢
        self._add_legend()
        
        # ÊÄßËÉΩË°®Á§∫„Ç®„É™„Ç¢
        self._setup_performance_display()
        
        print("üì∫ Visual comparison setup complete")
    
    def _add_legend(self):
        """Âá°‰æãËøΩÂä†"""
        legend_text = "Backend Comparison:\n"
        for i, (backend, name, color) in enumerate(self.backends):
            legend_text += f"‚óè {name} ({color})\n"
        
        self.plotter.add_text(
            legend_text,
            position='upper_left',
            font_size=12,
            color='white'
        )
    
    def _setup_performance_display(self):
        """ÊÄßËÉΩË°®Á§∫„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó"""
        # ÊÄßËÉΩ„É°„Éà„É™„ÇØ„ÇπË°®Á§∫Áî®„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„Ç¢„ÇØ„Çø„Éº
        self.perf_text_actor = self.plotter.add_text(
            "Initializing performance metrics...",
            position='lower_right',
            font_size=10,
            color='cyan'
        )
    
    def create_robot_visualization(self, backend_name: str, robot_id: int, position: List[float], color: str):
        """„É≠„Éú„ÉÉ„ÉàÂèØË¶ñÂåñ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê"""
        # „Ç∑„É≥„Éó„É´„Å™„É≠„Éú„ÉÉ„ÉàË°®ÁèæÔºöÂÜÜÊü± + ÊñπÂêëÊåáÁ§∫Âô®
        
        # „Éô„Éº„ÇπÔºàÂÜÜÊü±Ôºâ
        cylinder = pv.Cylinder(
            center=position,
            direction=[0, 0, 1],
            radius=0.3,
            height=0.2
        )
        
        # ÊñπÂêëÊåáÁ§∫Âô®ÔºàÁü¢Âç∞Ôºâ
        arrow = pv.Arrow(
            start=position,
            direction=[1, 0, 0],
            scale=0.5
        )
        
        # „É≠„Éú„ÉÉ„ÉàÂÖ®‰Ωì
        robot_mesh = cylinder + arrow
        
        # Ëâ≤Ë®≠ÂÆö
        robot_actor = self.plotter.add_mesh(
            robot_mesh,
            color=color,
            opacity=0.8,
            name=f"{backend_name}_robot_{robot_id}"
        )
        
        return robot_actor
    
    def setup_backend_simulations(self):
        """ÂêÑ„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö"""
        
        for i, (backend, name, color) in enumerate(self.backends):
            print(f"üîß Setting up {name}...")
            
            # „Éê„ÉÉ„ÇØ„Ç®„É≥„ÉâÂõ∫Êúâ„ÅÆË®≠ÂÆö
            if backend == simpyros.SimulationBackend.SIMPLE_WHILE_LOOP:
                config = simpyros.create_high_performance_config(visualization=False)
            else:
                config = simpyros.create_balanced_config(visualization=False)
            
            config.backend = backend
            config.real_time_factor = 0.0  # ÊúÄÈ´òÈÄüÂ∫¶
            config.verbose = False
            
            # „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÁÆ°ÁêÜ„ÇØ„É©„Çπ‰ΩúÊàê
            sim = simpyros.create_simulation_manager(config)
            
            # „É≠„Éú„ÉÉ„ÉàÁæ§„ÅÆÈÖçÁΩÆÔºà„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Åî„Å®„Å´Áï∞„Å™„Çã„Ç®„É™„Ç¢Ôºâ
            base_x = i * self.robot_spacing * 3
            robots_info = []
            
            for j in range(self.num_robots_per_backend):
                # „Ç∞„É™„ÉÉ„ÉâÈÖçÁΩÆ
                grid_size = int(math.sqrt(self.num_robots_per_backend)) + 1
                x = base_x + (j % grid_size) * self.robot_spacing
                y = (j // grid_size) * self.robot_spacing
                
                robot_name = f"{name}_robot_{j}"
                initial_pos = [x, y, 0]
                
                # „É≠„Éú„ÉÉ„ÉàÁä∂ÊÖãÁÆ°ÁêÜÁî®„ÅÆÁ∞°Âçò„Å™„ÇØ„É©„Çπ
                class RobotState:
                    def __init__(self, name, position):
                        self.name = name
                        self.position = position.copy()
                        self.velocity = simpyros.Velocity.zero()
                        self.angle = 0.0
                        self.update_count = 0
                
                robot_state = RobotState(robot_name, initial_pos)
                
                # ÂèØË¶ñÂåñ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà‰ΩúÊàê
                robot_actor = self.create_robot_visualization(
                    name, j, initial_pos, color
                )
                
                robots_info.append({
                    'name': robot_name,
                    'state': robot_state,
                    'actor': robot_actor,
                    'initial_pos': initial_pos.copy()
                })
                
                # „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Å´„É≠„Éú„ÉÉ„ÉàËøΩÂä†ÔºàÁ∞°Áï•ÁâàÔºâ
                try:
                    sim.robots[robot_name] = robot_state
                    
                    # Âà∂Âæ°„Ç≥„Éº„É´„Éê„ÉÉ„ÇØ
                    def create_controller(robot_state, robot_idx):
                        def controller(dt):
                            # ÂÜÜÈÅãÂãï„Éë„Çø„Éº„É≥
                            t = time.time() * 0.5
                            radius = 2.0
                            center_x, center_y = robot_state.initial_pos[0], robot_state.initial_pos[1]
                            
                            angle = t + robot_idx * 0.3
                            target_x = center_x + radius * math.cos(angle)
                            target_y = center_y + radius * math.sin(angle)
                            
                            # ‰ΩçÁΩÆÊõ¥Êñ∞
                            robot_state.position[0] = target_x
                            robot_state.position[1] = target_y
                            robot_state.angle = angle
                            robot_state.update_count += 1
                            
                        return controller
                    
                    sim.control_callbacks[robot_name] = create_controller(robot_state, j)
                    
                except Exception as e:
                    print(f"‚ö†Ô∏è Robot setup warning: {e}")
            
            # „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Éá„Éº„Çø‰øùÂ≠ò
            self.backends_data[name] = {
                'sim': sim,
                'robots': robots_info,
                'color': color,
                'backend': backend,
                'stats': {
                    'rtf': 0.0,
                    'fps': 0.0,
                    'callbacks_per_sec': 0.0,
                    'total_updates': 0
                }
            }
            
            print(f"‚úÖ {name}: {len(robots_info)} robots ready")
    
    def run_simulation_thread(self, backend_name: str):
        """„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÂÆüË°å„Çπ„É¨„ÉÉ„Éâ"""
        backend_data = self.backends_data[backend_name]
        sim = backend_data['sim']
        
        frame_count = 0
        start_time = time.time()
        last_update_time = start_time
        
        print(f"üöÄ Starting {backend_name} simulation thread")
        
        try:
            while self.running:
                frame_start = time.time()
                
                # Âà∂Âæ°„Ç≥„Éº„É´„Éê„ÉÉ„ÇØÂÆüË°å
                for robot_name, callback in sim.control_callbacks.items():
                    try:
                        callback(0.02)  # 50HzÁõ∏ÂΩì
                        backend_data['stats']['total_updates'] += 1
                    except Exception as e:
                        pass  # Silent error handling
                
                frame_count += 1
                
                # Áµ±Ë®àÊõ¥Êñ∞Ôºà1Áßí„Åî„Å®Ôºâ
                if time.time() - last_update_time >= 1.0:
                    elapsed = time.time() - start_time
                    if elapsed > 0:
                        backend_data['stats']['fps'] = frame_count / elapsed
                        backend_data['stats']['rtf'] = 1.0 if backend_name == "Simple While Loop" else 0.3  # Ê®°Êì¨ÂÄ§
                        backend_data['stats']['callbacks_per_sec'] = backend_data['stats']['total_updates'] / elapsed
                    
                    last_update_time = time.time()
                
                # „Éï„É¨„Éº„É†„É¨„Éº„ÉàÂà∂Âæ°
                frame_elapsed = time.time() - frame_start
                target_dt = 0.02  # 50Hz
                sleep_time = target_dt - frame_elapsed
                
                if sleep_time > 0:
                    time.sleep(sleep_time)
                    
        except Exception as e:
            print(f"‚ùå {backend_name} simulation error: {e}")
        
        print(f"üõë {backend_name} simulation thread stopped")
    
    def update_visualization(self):
        """ÂèØË¶ñÂåñÊõ¥Êñ∞„É°„Ç§„É≥„É´„Éº„Éó"""
        print("üé¨ Starting visualization update loop")
        
        last_update = time.time()
        frame_count = 0
        
        while self.running:
            try:
                current_time = time.time()
                
                # „É≠„Éú„ÉÉ„Éà‰ΩçÁΩÆÊõ¥Êñ∞
                for backend_name, backend_data in self.backends_data.items():
                    for robot_info in backend_data['robots']:
                        robot_state = robot_info['state']
                        actor = robot_info['actor']
                        
                        # Êñ∞„Åó„ÅÑ‰ΩçÁΩÆ„Åß„É°„ÉÉ„Ç∑„É•Êõ¥Êñ∞
                        new_pos = robot_state.position.copy()
                        new_pos[2] = 0.1  # Â∞ë„ÅóÊµÆ„Åã„Åõ„Çã
                        
                        # „É°„ÉÉ„Ç∑„É•„ÅÆ‰ΩçÁΩÆÊõ¥Êñ∞
                        try:
                            # PyVista„ÅÆ„Ç¢„ÇØ„Çø„Éº‰ΩçÁΩÆÊõ¥Êñ∞
                            transform = pv.Transform()
                            transform.translate(new_pos)
                            transform.rotate_z(math.degrees(robot_state.angle))
                            
                            # „Ç¢„ÇØ„Çø„ÉºÊõ¥Êñ∞ÔºàÁ∞°Áï•ÂåñÔºâ
                            # ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÈÅ©Âàá„Å™„É°„ÉÉ„Ç∑„É•Â§âÊèõ„ÅåÂøÖË¶Å
                            
                        except Exception as e:
                            pass  # ÂèØË¶ñÂåñ„Ç®„É©„Éº„ÅØÁÑ°Ë¶ñ
                
                # ÊÄßËÉΩÁµ±Ë®àË°®Á§∫Êõ¥Êñ∞
                if current_time - last_update >= 0.5:  # 0.5Áßí„Åî„Å®
                    self._update_performance_display()
                    last_update = current_time
                
                frame_count += 1
                
                # ÂèØË¶ñÂåñ„Éï„É¨„Éº„É†„É¨„Éº„ÉàÂà∂Âæ°
                time.sleep(0.033)  # Á¥Ñ30 FPS
                
            except Exception as e:
                print(f"‚ö†Ô∏è Visualization update error: {e}")
                break
        
        print("üé¨ Visualization update loop stopped")
    
    def _update_performance_display(self):
        """ÊÄßËÉΩË°®Á§∫Êõ¥Êñ∞"""
        perf_text = "Real-time Performance:\n\n"
        
        for backend_name, backend_data in self.backends_data.items():
            stats = backend_data['stats']
            color = backend_data['color']
            
            perf_text += f"‚óè {backend_name}:\n"
            perf_text += f"  RTF: {stats['rtf']:.3f}x\n"
            perf_text += f"  FPS: {stats['fps']:.1f}\n"
            perf_text += f"  CB/s: {stats['callbacks_per_sec']:.0f}\n"
            perf_text += f"  Updates: {stats['total_updates']:,}\n\n"
        
        # „ÉÜ„Ç≠„Çπ„Éà„Ç¢„ÇØ„Çø„ÉºÊõ¥Êñ∞
        try:
            self.perf_text_actor.SetText(3, perf_text)
        except:
            pass
    
    def run_demo(self, duration: float = 30.0):
        """„Éá„É¢ÂÆüË°å"""
        
        if not PYVISTA_AVAILABLE:
            print("‚ùå PyVista not available. Cannot run visual demo.")
            return
        
        print("üéØ Visual Backend Comparison Demo Starting")
        print("=" * 50)
        print(f"Duration: {duration}s")
        print(f"Backends: {[name for _, name, _ in self.backends]}")
        print(f"Robots per backend: {self.num_robots_per_backend}")
        
        try:
            # 1. ÂèØË¶ñÂåñ„Çª„ÉÉ„Éà„Ç¢„ÉÉ„Éó
            self.setup_visualization()
            
            # 2. „Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥Ë®≠ÂÆö
            self.setup_backend_simulations()
            
            # 3. „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÈñãÂßã
            self.running = True
            
            # ÂêÑ„Éê„ÉÉ„ÇØ„Ç®„É≥„Éâ„ÅÆ„Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥„Çπ„É¨„ÉÉ„ÉâÈñãÂßã
            sim_threads = []
            for backend_name in self.backends_data.keys():
                thread = threading.Thread(
                    target=self.run_simulation_thread,
                    args=(backend_name,),
                    daemon=True
                )
                thread.start()
                sim_threads.append(thread)
            
            # ÂèØË¶ñÂåñÊõ¥Êñ∞„Çπ„É¨„ÉÉ„ÉâÈñãÂßã
            viz_thread = threading.Thread(
                target=self.update_visualization,
                daemon=True
            )
            viz_thread.start()
            
            # PyVista„Ç¶„Ç£„É≥„Éâ„Ç¶Ë°®Á§∫
            print("üñ•Ô∏è Opening PyVista visualization window...")
            print("   - Â∑¶ÂÅ¥: Simple While Loop (red)")
            print("   - Âè≥ÂÅ¥: SimPy FrequencyGroup (blue)")
            print("   - Âè≥‰∏ã: „É™„Ç¢„É´„Çø„Ç§„É†ÊÄßËÉΩÁµ±Ë®à")
            print("   - „Ç¶„Ç£„É≥„Éâ„Ç¶„ÇíÈñâ„Åò„Çã„Å®„Éá„É¢ÁµÇ‰∫Ü")
            
            # Âà∂Âæ°„Éú„Çø„É≥ËøΩÂä†
            self._add_control_widgets()
            
            # „É°„Ç§„É≥„É´„Éº„ÉóÔºàPyVista„Ç¶„Ç£„É≥„Éâ„Ç¶„ÅåÈñã„ÅÑ„Å¶„ÅÑ„ÇãÈñìÔºâ
            start_time = time.time()
            
            def timer_callback():
                elapsed = time.time() - start_time
                if elapsed >= duration:
                    self.plotter.close()
                    return
                
                # „Çø„Ç§„Éà„É´Êõ¥Êñ∞
                remaining = duration - elapsed
                self.plotter.textActor.SetText(3, 
                    f"SimPyROS Backend Comparison - {remaining:.1f}s remaining")
            
            # „Çø„Ç§„Éû„ÉºË®≠ÂÆö
            self.plotter.add_timer_event(1000, timer_callback)  # 1Áßí„Åî„Å®
            
            # „Ç¶„Ç£„É≥„Éâ„Ç¶Ë°®Á§∫Ôºà„Éñ„É≠„ÉÉ„Ç≠„É≥„Ç∞Ôºâ
            self.plotter.show()
            
        except KeyboardInterrupt:
            print("\n‚èπÔ∏è Demo interrupted by user")
        
        except Exception as e:
            print(f"‚ùå Demo error: {e}")
            import traceback
            traceback.print_exc()
        
        finally:
            # „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            self.running = False
            
            # „Ç∑„Éü„É•„É¨„Éº„Ç∑„Éß„É≥ÁµÇ‰∫Ü
            for backend_data in self.backends_data.values():
                try:
                    backend_data['sim'].shutdown()
                except:
                    pass
            
            print("\nüìä Final Performance Summary:")
            print("-" * 40)
            
            for backend_name, backend_data in self.backends_data.items():
                stats = backend_data['stats']
                print(f"{backend_name}:")
                print(f"  Average RTF: {stats['rtf']:.3f}x")
                print(f"  Total Updates: {stats['total_updates']:,}")
                print(f"  Final CB/s: {stats['callbacks_per_sec']:.1f}")
            
            print("\n‚úÖ Visual comparison demo completed!")
    
    def _add_control_widgets(self):
        """Âà∂Âæ°„Ç¶„Ç£„Ç∏„Çß„ÉÉ„ÉàËøΩÂä†"""
        try:
            # ‰∏ÄÊôÇÂÅúÊ≠¢/ÂÜçÈñã„Éú„Çø„É≥ÔºàÁ∞°Áï•ÂåñÔºâ
            def toggle_pause():
                # Á∞°Âçò„Å™ÂÆüË£Ö
                pass
            
            # ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÈÅ©Âàá„Å™„Ç¶„Ç£„Ç∏„Çß„ÉÉ„Éà„ÇíËøΩÂä†
            
        except Exception as e:
            print(f"‚ö†Ô∏è Widget setup warning: {e}")


def simplified_visual_demo():
    """Á∞°Áï•Âåñ„Åï„Çå„ÅüË¶ñË¶ö„Éá„É¢ÔºàPyVista„Å™„Åó„Åß„ÇÇÂãï‰ΩúÔºâ"""
    
    print("üéØ Simplified Visual Backend Comparison")
    print("=" * 50)
    
    backends = [
        (simpyros.SimulationBackend.SIMPLE_WHILE_LOOP, "Simple While Loop"),
        (simpyros.SimulationBackend.SIMPY_FREQUENCY_GROUP, "SimPy FrequencyGroup")
    ]
    
    print("Comparing backends with console output...")
    
    for backend, name in backends:
        print(f"\nüß™ Testing {name}...")
        
        try:
            # Ë®≠ÂÆö
            if backend == simpyros.SimulationBackend.SIMPLE_WHILE_LOOP:
                config = simpyros.create_high_performance_config()
            else:
                config = simpyros.create_balanced_config()
            
            config.backend = backend
            config.visualization = False
            
            # „ÇØ„Ç§„ÉÉ„ÇØ„ÉÜ„Çπ„Éà
            stats = simpyros.quick_simulation(
                num_robots=20,
                backend=backend,
                visualization=False,
                duration=2.0
            )
            
            print(f"   RTF: {stats['rtf']:.3f}x")
            print(f"   Callbacks/sec: {stats['callbacks_per_sec']:.1f}")
            
            # Ë¶ñË¶öÁöÑ„Å™ÊÄßËÉΩË°®Á§∫
            bar_length = int(stats['rtf'] * 20)
            bar = "‚ñà" * bar_length + "‚ñë" * (20 - bar_length)
            print(f"   Performance: |{bar}| {stats['rtf']:.3f}x")
            
        except Exception as e:
            print(f"   ‚ùå Error: {e}")
        
        time.sleep(1.0)
    
    print(f"\nüí° For full visual experience, install PyVista:")
    print(f"   pip install pyvista")


def main():
    """„É°„Ç§„É≥ÂÆüË°å"""
    
    print("üéÆ SimPyROS Visual Backend Comparison Demo")
    print("=" * 60)
    
    try:
        if PYVISTA_AVAILABLE:
            # „Éï„É´Ë¶ñË¶ö„Éá„É¢
            print("üì∫ PyVista available - running full visual demo")
            
            response = input("Run visual demo? (y/n): ").lower().strip()
            if response.startswith('y'):
                demo = VisualComparisonDemo()
                demo.run_demo(duration=20.0)
            else:
                print("Demo cancelled")
        else:
            print("‚ö†Ô∏è PyVista not available - running simplified demo")
            simplified_visual_demo()
    
    except KeyboardInterrupt:
        print("\n‚èπÔ∏è Demo interrupted")
    except Exception as e:
        print(f"\n‚ùå Demo failed: {e}")
        import traceback
        traceback.print_exc()


if __name__ == "__main__":
    main()